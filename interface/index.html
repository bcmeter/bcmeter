<!DOCTYPE html>
<meta charset="utf-8">
<style>
  body,
  svg,
  .menu {
    padding: 20px;
    display: inline-block;
    margin: 0px auto;
    font-family: 'Poppins', sans-serif !important;
  }

  .menu {
     margin: 15px auto;
  }

  .menu select {
    height: 35px;
    margin: 0px 5px;
    border-radius: 3px;
    outline: none;
    font-family: 'Poppins', sans-serif !important;
    font-size: 15px;
  }



  .menu .btn {
    border-radius: 0px;
    padding: 5px 15px;
    margin: 0px 10px;
    box-shadow: 0 1px 2px rgb(0 0 0 / 30%), inset 0 1px 1px rgb(255 255 255 / 30%);
    border: 1px solid #ccc;
    cursor: pointer;

  }


  .menu span a {
    text-decoration: none !important;
    color: #000;
  }

  #y-menu select{
    border: solid 2px #1f77b4 !important;;
  }

  #y-menu2 select, #hide-y-menu2 {
    border: solid 2px #ff7f0e !important;
  }

  #hide-y-menu2 {
    box-shadow: 0 1px 2px rgb(0 0 0 / 30%), inset 0 1px 1px rgb(255 255 255 / 30%);
    background-color: #ccc;
    color: #fff;
    border: none!important;
  }


  h3 {
    text-align: center;
  }

  path {

    stroke-width: 2;
    fill: none;
  }

  .tooltip {
    padding: 3px;
    background-color: #ccc;
    border: 1px solid rgb(175, 175, 175);
    width: auto;
    border-radius: 3px;
    position: absolute;
    left: 0px;
    font-size: 11px;
    display: inline-block;
    opacity: 0;
  }

  .selected-time-line {
    stroke-width: 2;
    stroke: rgb(168, 167, 167);
    stroke-linecap: round;
  }
</style>

<body>
  <a href="" id="download" style="display: none;"></a>
  <h3>bcMeter current measurement</h3>

  <!-- CONTAINER FOR CHART -->
  <div class="tooltip"></div>
  <svg id="line-chart" width="1200" height="480" style="margin: 30px auto 0px">
    <style type="text/css">
      @import url('https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,200;0,300;0,400;0,600;0,700;1,300;1,400&display=swap');

      text {
        font-size: 11px;
        font-weight: bold;
        font-family: 'Poppins', sans-serif !important;
      }

      #line-chart .tick line,
      #line-chart .domain {
        stroke: #eeebeb
      }

      #line-chart .domain {
        stroke: #ddd
      }

      #line-chart .x-axis-label,
      #line-chart .y-axis-label,
      #line-chart .y-axis-label2 {
        font-size: 14px;
      }
    </style>
  </svg>


  <br />
   <!-- CONTAINER FOR DROP DOWN MENU -->
  <div class="menu">
    Select data:
    <span id="y-menu"></span>

   
  </div>
  <div class="menu" style="background-color: #eee;padding:10px;">
    <span id="y-menu2"></span>
    <span class="btn" id="hide-y-menu2">Show 2nd Graph</span>
  </div>

  <div class="menu">
     Save data as:
    <span class="btn" id="svg"> SVG</span>
    <span class="btn" id="png"> PNG</span>
    <span class="btn"><a href="../logs/current.csv"> CSV</a></span>
</div><br />
_6 and _12 refers to the number of samples taken as rolling average (30 vs 60 minutes on a 5 minute time base)
  <!-- load the d3.js library -->
  <script src="js/d3.min.js"></script>

  <script>
    /* VAR AND CONST */
    let yColumn2 = "",
      yColumn = "",
      tooltip,
      hoveredTime = 0,
      idx = 0;
    let isHidden = true;
    let yValue, yValue2, yValueScale, yValueScale2, yLabel, yLabel2;
    let data = [];
    const svg = d3.select("svg");
    const width = +svg.attr("width");
    const height = +svg.attr("height");
    const parseTime = d3.timeParse("%Y-%m-%d %H:%M:%S");
    const title = "bcMeter";
    const margin = {
      top: 15,
      right: 110,
      bottom: 55,
      left: 110
    };
    const innerWidth = width - margin.left - margin.right;
    const innerHeight = height - margin.top - margin.bottom;
    const xValue = (d) => d.bcmTime;
    const download = document.getElementById("download");
    const bisect = d3.bisector(function (d) {
      return d.bcmTime;
    }).left;
    const xLabel = "bcmTime";

    /* FUNCTION CALLED ON MENU SELECT */
    const yOptionClicked = (value) => {
      yColumn = value
      render();
    }
    const yOptionClicked2 = (value) => {
      yColumn2 = value
      render();
    }

    /* FUNCTION THAT PLOT THE CHART */
    const plotChart = () => {

      // SCALE FOR BOTH X AND Y AXIS
      const xScale = d3.scaleTime()
        .domain(d3.extent(data, xValue))
        .range([0, innerWidth])
        .nice();

      const yScale = d3.scaleLinear()
        .domain(d3.extent(data, yValueScale))
        .range([innerHeight, 0])
        .nice();

      const yScale2 = d3.scaleLinear()
        .domain(d3.extent(data, yValueScale2))
        .range([innerHeight, 0])
        .nice();

      /* CHART CONTAINER */
      const g = svg.selectAll('.container').data([null]);
      const gEnter = g
        .enter().append("g")
        .attr('class', 'container');
      gEnter.merge(g)
        .attr("transform", `translate(${margin.left}, ${margin.top})`);

      /* Y-AXIS */
      const yAxis = d3.axisLeft(yScale)
        .ticks(9)
        .tickSize(-innerWidth)
        .tickPadding(8);
      const yAxisG = g.select('.y-axis');
      const yAxisGEnter = gEnter
        .append('g')
        .attr('class', 'y-axis');
      yAxisG.merge(yAxisGEnter)
        .call(yAxis);
      yAxisG.selectAll(".domain").remove();
      const yAxisLabelText = yAxisGEnter
        .append("text")
        .attr('class', 'y-axis-label')
        .attr("y", -70)
        .attr("x", -innerHeight / 2)
        .attr("text-anchor", "middle")
        .attr("transform", `rotate(-90)`)
        .attr("fill", "black")
        .merge(yAxisG.select('.y-axis-label'))
        .transition().duration(1000)
        .text(yLabel);

      const yAxis2 = d3.axisRight(yScale2)
        .ticks(9)
        .tickSize(innerWidth)
        .tickPadding(8);
      const yAxisG2 = g.select('.y-axis2');
      const yAxisGEnter2 = gEnter
        .append('g')
        .attr('class', 'y-axis2')
        .style('opacity', 0 )
      yAxisG2.merge(yAxisGEnter2)
        .call(yAxis2);
      yAxisG2.selectAll(".domain").remove();
      const yAxisLabelText2 = yAxisGEnter2
        .append("text")
        .attr('class', 'y-axis-label2')
        .attr("y", innerWidth + 70)
        .attr("x", -innerHeight / 2)
        .attr("text-anchor", "middle")
        .attr("transform", `rotate(-90)`)
        .attr("fill", "black")
        .merge(yAxisG2.select('.y-axis-label2'))
        .transition().duration(1000)
        .text(yLabel2);

      /* X-AXIS */
      const xAxis = d3
        .axisBottom(xScale)
        .tickSize(-innerHeight)
        .tickPadding(15);
      const xAxisG = g.select('.x-axis');
      const xAxisGEnter = gEnter
        .append("g")
        .attr('class', 'x-axis');
      xAxisG.merge(xAxisGEnter)
        .attr("transform", `translate(0, ${innerHeight})`)
        .call(xAxis);
      const xAxisLabelText = xAxisGEnter
        .append("text")
        .attr('class', 'x-axis-label')
        .attr("y", 50)
        .attr("x", innerWidth / 2)
        .attr("fill", "black")
        .attr("text-anchor", "middle")

        .merge(xAxisG.select('.x-axis-label'))
        .text(xLabel);

      /* LINE CHART GENERATOR */
      const lineGenerator = d3.line()
        .x((d) => xScale(xValue(d)))
        .y((d) => yScale(yValue(d)))

      const lineGenerator2 = d3.line()
        .x((d) => xScale(xValue(d)))
        .y((d) => yScale2(yValue2(d)))

      /* TO HANDLE NULL VALUE FOR ROLLING AVERAGE */
      if (yColumn == "BCngm3_6" || yColumn == "BCngm3_12") {
        lineGenerator.defined(d => d[yColumn] !== null)
      }
      if (yColumn2 == "BCngm3_6" || yColumn2 == "BCngm3_12") {
        lineGenerator2.defined(d => d[yColumn2] !== null)
      }

      /* GENERATE PATH */
      gEnter.append("path")
        .attr('class', 'line-chart2')
        .attr('stroke', '#ff7f0e')
        .attr('fill', 'none')
        .attr("stroke-width", "2")
        .style('opacity', 0 )
        .merge(g.select('.line-chart2'))
        .transition().duration(1000)
        .attr('d', lineGenerator2(data));

      gEnter.append("path")
        .attr('class', 'line-chart')
        .attr('stroke', '#1f77b4')
        .attr('fill', 'none')
        .attr("stroke-width", "2")
        .merge(g.select('.line-chart'))
        .transition().duration(1000)
        .attr('d', lineGenerator(data));

      /* MOVING LINE */
      gEnter.append("line")
        .attr("class", "selected-time-line")
        .attr("y1", 0)
        .style("opacity", "0")
        .merge(g.select('.selected-time-line'))


      /* ADDING CIRCLE ON MOUSE MOVE */
      gEnter.append("circle")
        .attr("r", 4)
        .attr("class", "y-circle")
        .attr("fill", "#1f77b4")
        .style("stroke", "black")
        .style("stroke-width", "1.5px")
        .style("opacity", "0")
        .merge(g.select('.y-circle'))


      gEnter.append("circle")
        .attr("r", 4)
        .attr("class", "y2-circle")
        .attr("fill", "#ff7f0e")
        .style("stroke", "black")
        .style("stroke-width", "1.5px")
        .style("opacity", "0")
        .merge(g.select('.y2-circle'))

      gEnter.append("rect")
        .attr("class", 'mouse-interceptor')
        .attr("fill", "none")
        .attr("pointer-events", "all")
        .merge(g.select('.mouse-interceptor'))
        .attr("width", innerWidth)
        .attr("height", innerHeight)

        .on("mousemove", function (e) {
          if (data.length != 0) {
            const x = d3.pointer(e)[0];
            hoveredTime = xScale.invert(x);
            let bi = bisect(data, hoveredTime) - 1
            idx = bi < 0 ? 0 : bi;
            console.log(idx);
            const temp = data[idx];
            const maxLeft = e.pageX > xScale(data[data.length - 1][xLabel]) ? xScale(data[idx][xLabel]) : e.pageX;
            let tooltipMessage = (!isHidden) ? `<div><b>Date:</b>  ${temp["bcmTimeRaw"]}</div>
                        <div><b>${yColumn}:</b>  ${temp[yColumn]}</div>
                         <div><b>${yColumn2}:</b>  ${temp[yColumn2]}</div>
                        ` : `<div><b>Date:</b>  ${temp["bcmTimeRaw"]}</div>
                        <div><b>${yColumn}:</b>  ${temp[yColumn]}</div>
                        `
            d3.select('.tooltip').style("left", maxLeft + 10 + "px")
              .style("top", "150px")
              .style("opacity", "1")
              .html( tooltipMessage)
            d3.select(".selected-time-line")
              .attr("x1", xScale(temp[xLabel]))
              .attr("x2", xScale(temp[xLabel]))
              .attr("y2", innerHeight)
              .style("opacity", "1")
              
            if(!isHidden){
            d3.select('.y2-circle')
              .attr("cx", xScale(temp[xLabel]))
              .attr("cy", yScale2(temp[yColumn2]))
              .style("opacity", "1")
            }

            d3.select('.y-circle')
              .attr("cx", xScale(temp[xLabel]))
              .attr("cy", yScale(temp[yColumn]))
              .style("opacity", "1");
          }
        })

        .on("mouseout", function (e) {
          d3.select('.tooltip')
            .style("opacity", "0");
          d3.select(".selected-time-line")
            .style("opacity", "0");
          d3.select('.y-circle')
            .style("opacity", "0");
          d3.select('.y2-circle')
            .style("opacity", "0");
        })
    }

    /* CREATE MENU */
    function selectUpdate(options, id, theFunction, selectedOption) {
      const menu = d3.select(id);
      let select = menu.selectAll("select").data([null]);
      select = select.enter().append('select').merge(select)
        .on("change", function () {
          theFunction(this.value)
        })
      let option = select.selectAll('option').data(options);
      option.enter().append('option')
        .merge(option)
        .attr('value', d => d)
        .property("selected", d => d === selectedOption)
        .text(d => d);
    }

    /* RENDER FUNCTION THAT CALLS CHART PLOT */
    const render = () => {
      selectUpdate(data["columns"], "#y-menu", yOptionClicked, yColumn);
      selectUpdate(data["columns"], "#y-menu2", yOptionClicked2, yColumn2);
      yValue = (d) => d[yColumn];
      yValue2 = (d) => d[yColumn2];
      if ((((yColumn == "BCngm3_6" || yColumn == "BCngm3_12") && yColumn2 == "BCngm3") ||
        ((yColumn2 == "BCngm3_6" || yColumn2 == "BCngm3_12") && yColumn == "BCngm3")) && !isHidden) {
        yValueScale = (d) => d["BCngm3"];
        yValueScale2 = (d) => d["BCngm3"];
      } else {
        yValueScale = yValue;
        yValueScale2 = yValue2;
      }
      yLabel = yColumn;
      yLabel2 = yColumn2;;
      plotChart();
    };

    const dataFile = (file) => {
      d3.dsv(';', file).then((rawData) => {
        rawData.forEach((d, i) => {
          if (d.bcmTime) {
            d.bcmTimeRaw = d.bcmDate + ' ' + d.bcmTime;
            d.bcmTime = parseTime(d.bcmDate + ' ' + d.bcmTime);
            d.bcmRef = +d.bcmRef;
            d.bcmSen = +d.bcmSen;
            d.bcmATN = +d.bcmATN;
            d.relativeLoad = +d.relativeLoad;
            d.BCngm3 = +d.BCngm3;
            d.Temperature = +d.Temperature;
            data.push(d)

            /* MOVING AVERAGE = 6 */
            if (i < 6) {
              d.BCngm3_6 = null;
            } else {
              d.BCngm3_6 = +(((data.slice(i - 5, i).reduce((c, a) => c + a.BCngm3, 0)) / 6).toFixed(2))
            }
            /* MOVING AVERAGE = 12 */
            if (i < 12) {
              d.BCngm3_12 = null;
            } else {
              d.BCngm3_12 = +(((data.slice(i - 11, i).reduce((c, a) => c + a.BCngm3, 0)) / 12).toFixed(2))
            }
          }
        });

        data["columns"] = ["BCngm3", "BCngm3_6", "BCngm3_12", "bcmATN", "bcmRef", "bcmSen","Temperature"]
        /* TO MAINTAIN THE SELECTED MENU ON REFRESH */
        if (yColumn == "" || yColumn2 == "") {
          yColumn = data.columns[2];
          yColumn2 = data.columns[5];
        }
        render();
      });
    }


    /* INITIAL LOAD */
    dataFile("../logs/current.csv")
    // RELOADING EVERY 10s
    setInterval(() => {
      // SINCE NEW FILE ON EACH REFRESH, I NEED TO CLEAR THE PREVIOUS
      data = [];
      dataFile("../logs/current.csv")
    }, 10000);

    const serializeData = () => {
      var png = (new XMLSerializer()).serializeToString(document.getElementById("line-chart"));
      var svgBlob = new Blob([png], {
        type: "image/svg+xml;charset=utf-8"
      });
      var svgURL = URL.createObjectURL(svgBlob);
      return {
        svgURL,
        svgBlob
      }
    }

    const saveSVG = () => {
      downloadFile(serializeData()["svgURL"], "svg")
    }

    const savePNG = () => {
      var dom = document.createElement("canvas");
      var ct = dom.getContext("2d");
      dom.width = width;
      dom.height = height;
      var bolbURL = window.URL;
      var img = new Image();

      img.onload = function () {
        ct.drawImage(img, 0, 0);
        bolbURL.createObjectURL(serializeData()["svgBlob"]);
        downloadFile(dom.toDataURL('image/png'), "png")
      };
      img.src = serializeData()["svgURL"];
    }

    const downloadFile = (url, ext) => {
      var savingWord = (!isHidden) ? `bcMeter-(${yColumn}-vs-${yColumn2})` : `bcMeter-${yColumn}`;
      download.href = url;
      download.download = `${savingWord}.${ext}`;
      download.click();
    }

    document.getElementById("svg").addEventListener("click", saveSVG);
    document.getElementById("png").addEventListener("click", savePNG);

    document.getElementById("hide-y-menu2").addEventListener("click", function() {
      isHidden = !isHidden;
      if ((((yColumn == "BCngm3_6" || yColumn == "BCngm3_12") && yColumn2 == "BCngm3") ||
        ((yColumn2 == "BCngm3_6" || yColumn2 == "BCngm3_12") && yColumn == "BCngm3")) && !isHidden) {
          render()
      }
      this.innerHTML = (!isHidden) ? `Hide` : `Show`;
      d3.select('.y-axis2').style("opacity", Number(!isHidden))
      d3.select('.line-chart2').style("opacity", Number(!isHidden))

    });
  </script>

</body>